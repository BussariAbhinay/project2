From b1bf52c80fb837175a6b9fe2efa61144cafc1739 Mon Sep 17 00:00:00 2001
From: Muhammad Falak R Wani <falakreyaz@gmail.com>
Date: Wed, 27 Mar 2024 12:51:41 +0530
Subject: [PATCH 2/2] CVE-2024-23652

Signed-off-by: Muhammad Falak R Wani <falakreyaz@gmail.com>
---
 vendor/github.com/moby/buildkit/executor/stubs.go | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/vendor/github.com/moby/buildkit/executor/stubs.go b/vendor/github.com/moby/buildkit/executor/stubs.go
index 2c13b13..db56236 100644
--- a/vendor/github.com/moby/buildkit/executor/stubs.go
+++ b/vendor/github.com/moby/buildkit/executor/stubs.go
@@ -4,6 +4,7 @@ import (
 	"errors"
 	"os"
 	"path/filepath"
+	"strings"
 	"syscall"
 
 	"github.com/containerd/continuity/fs"
@@ -36,6 +37,11 @@ func MountStubsCleaner(dir string, mounts []Mount) func() {
 
 	return func() {
 		for _, p := range paths {
+			p, err := fs.RootPath(dir, strings.TrimPrefix(p, dir))
+			if err != nil {
+				continue
+			}
+
 			st, err := os.Lstat(p)
 			if err != nil {
 				continue
@@ -43,6 +49,11 @@ func MountStubsCleaner(dir string, mounts []Mount) func() {
 			if st.Size() != 0 {
 				continue
 			}
+
+			parent := filepath.Dir(p)
+			if realPath, err := fs.RootPath(dir, strings.TrimPrefix(parent, dir)); err != nil || realPath != parent {
+				continue
+			}
 			os.Remove(p)
 		}
 	}
-- 
2.40.1

